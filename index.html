<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>發票明細審核</title>
    <!-- Tailwind (CDN 版本；若上 Production，建議用 CLI 或 PostCSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React / ReactDOM / Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <!-- SheetJS -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div id="root" class="p-4"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;
      console.log('[boot] inline app script loaded');

      // -------- Helpers --------
      const normalizeAmount = (v) => {
        const s = String(v ?? '')
          .replace(/,/g, '')
          .replace(/\s+/g, '')
          .replace(/^NT\$?/i, '')
          .replace(/元$/i, '');
        const n = parseFloat(s);
        return Number.isFinite(n) ? n : 0;
      };
      const isInvoiceSheet = (name) =>
        /^(invoice|btb411w_xls1)$/i.test(String(name).trim());
      const isDetailSheet = (name) =>
        /^(invoice_details|btb411w_xls2)$/i.test(String(name).trim());

      // 專用元件：安全渲染清單，避免相鄰 JSX
      function ItemDetailsList({ items }) {
        const list = Array.isArray(items) ? items : [];
        try {
          console.log('[ItemDetailsList] received:', {
            len: list.length,
            sample: list.slice(0, 3),
          });
        } catch (e) {}
        if (!list.length) {
          return (
            <div className="text-gray-400 italic text-xs">無商品資料</div>
          );
        }
        return (
          <div>
            {list.map((it, i) => {
              // 這裡保底：若 amount 無值，退回 originalRow[7]
              const amt =
                typeof it?.amount === 'number' && Number.isFinite(it.amount)
                  ? it.amount
                  : normalizeAmount(it?.originalRow?.[7]);
              return (
                <div
                  key={i}
                  className="bg-gray-50 px-2 py-1 rounded text-xs text-gray-800 flex items-center justify-between"
                >
                  <span>{it?.name || '(無品名)'}</span>
                  <span>{Number(amt || 0).toLocaleString()}</span>
                </div>
              );
            })}
          </div>
        );
      }

      // -------- XLSX 讀取 --------
      async function readFileToWorkbook(file) {
        const data = await file.arrayBuffer();
        // 這裡使用 SheetJS 自動判斷格式
        const workbook = XLSX.read(data, { type: 'array' });
        try {
          console.log('[xlsx] SheetNames:', workbook.SheetNames);
        } catch (e) {}
        return workbook;
      }

      function readExcelSheet(sheetName, sheet) {
        console.log('[readExcelSheet] enter:', sheetName);
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 }) || [];
        const rows = json.slice(1); // 跳過標題列
        console.log(
          '[readExcelSheet] rows:',
          rows.length,
          'first row sample:',
          rows[0]
        );

        if (isInvoiceSheet(sheetName)) {
          const processed = rows
            .map((row, idx) => ({
              invoiceNumber: row[0] || '',
              buyerNote: row[1] || '',
              sellerId: String(row[7] || ''),
              sellerName: row[8] || '',
              originalRow: row,
              rowIndex: idx + 2,
            }))
            .filter((x) => x.invoiceNumber);
          console.log(
            '[readExcelSheet] INVOICE processed size:',
            processed.length,
            'sample:',
            processed.slice(0, 3)
          );
          return { type: 'invoice', rows: processed };
        }

        if (isDetailSheet(sheetName)) {
          const processed = rows
            .map((row, idx) => ({
              invoiceNumber: row[0] || '',
              itemName: row[3] || '',
              amount: normalizeAmount(row[7]), // H 欄金額（去千分位/雜字）
              originalRow: row,
              rowIndex: idx + 2,
            }))
            .filter(
              (it) =>
                String(it.invoiceNumber || '').trim() &&
                String(it.itemName || '').trim()
            );
          console.log(
            '[readExcelSheet] DETAIL processed size:',
            processed.length,
            'sample:',
            processed.slice(0, 5)
          );
          return { type: 'detail', rows: processed };
        }

        console.warn(
          '[readExcelSheet] unknown sheet:',
          sheetName,
          'fallback=DETAIL parser'
        );
        const fallback = rows
          .map((row, idx) => ({
            invoiceNumber: row[0] || '',
            itemName: row[3] || '',
            amount: normalizeAmount(row[7]),
            originalRow: row,
            rowIndex: idx + 2,
          }))
          .filter(
            (it) =>
              String(it.invoiceNumber || '').trim() &&
              String(it.itemName || '').trim()
          );
        console.log(
          '[readExcelSheet] DETAIL fallback size:',
          fallback.length,
          'sample:',
          fallback.slice(0, 5)
        );
        return { type: 'detail', rows: fallback };
      }

      // -------- 清洗與彙總 --------
      function buildConsolidated(items) {
        const m = new Map();
        for (const it of items) {
          const name = String(it.name || '').trim();
          if (!name) continue;
          const amt =
            typeof it.amount === 'number' && Number.isFinite(it.amount)
              ? it.amount
              : 0;
          m.set(name, (m.get(name) || 0) + amt);
        }
        return Array.from(m.entries()).map(([name, amount]) => ({
          name,
          amount,
        }));
      }

      function initialDataCleaning(invoiceData, invoiceDetailsData) {
        // 把明細依發票號碼 group 起來，避免重複 filter
        const detailsByInv = new Map();
        for (const d of invoiceDetailsData || []) {
          const key = String(d.invoiceNumber || '').trim();
          if (!key) continue;
          if (!detailsByInv.has(key)) detailsByInv.set(key, []);
          detailsByInv.get(key).push(d);
        }

        const cleaned = (invoiceData || []).map((inv) => {
          const invNo = String(inv.invoiceNumber || '').trim();
          const rawDetails = detailsByInv.get(invNo) || [];

          const invItemDetails = rawDetails
            .map((d) => ({
              name: d.itemName,
              amount:
                typeof d.amount === 'number' && Number.isFinite(d.amount)
                  ? d.amount
                  : normalizeAmount(d?.originalRow?.[7]),
              originalRow: d.originalRow, // 傳下去給 UI 作保底
            }))
            .filter((it) => it.name);

          const invItems = invItemDetails.map((it) => it.name);
          const consolidatedItemDetails = buildConsolidated(invItemDetails);

          try {
            console.log(
              '[initialDataCleaning] invNumber:',
              invNo,
              'rawDetails size:',
              rawDetails.length,
              'itemDetails sample:',
              invItemDetails.slice(0, 5),
              'consolidated size:',
              consolidatedItemDetails.length
            );
          } catch (e) {}

          return {
            ...inv,
            buyerNote: inv.buyerNote || '待查',
            items: invItems,
            consolidatedItems: Array.from(new Set(invItems)), // 你的舊邏輯（品名去重）
            consolidatedItemDetails, // 新：品名＋金額（合計）
          };
        });

        return cleaned;
      }

      // -------- App --------
      function App() {
        const [workbook, setWorkbook] = useState(null);
        const [invoiceData, setInvoiceData] = useState([]);
        const [invoiceDetailsData, setInvoiceDetailsData] = useState([]);
        const [pendingReviews, setPendingReviews] = useState([]);
        const [currentReviewIndex, setCurrentReviewIndex] = useState(0);
        const [currentStep, setCurrentStep] = useState(1);

        const handleFile = async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          const wb = await readFileToWorkbook(file);
          setWorkbook(wb);

          // 走訪各 sheet
          let invRows = [];
          let detRows = [];
          for (const sheetName of wb.SheetNames) {
            try {
              console.log(
                '[xlsx] dispatch ->',
                sheetName,
                'isInvoice?',
                isInvoiceSheet(sheetName),
                'isDetail?',
                isDetailSheet(sheetName)
              );
            } catch (e) {}
            const sheet = wb.Sheets[sheetName];
            const res = readExcelSheet(sheetName, sheet);
            if (res.type === 'invoice') invRows = invRows.concat(res.rows);
            if (res.type === 'detail') detRows = detRows.concat(res.rows);
          }
          setInvoiceData(invRows);
          setInvoiceDetailsData(detRows);

          const cleaned = initialDataCleaning(invRows, detRows);
          // 這裡直接用展開，避免遺漏欄位（確保 consolidatedItemDetails 留存）
          const nextPending = cleaned.map((inv) => ({ ...inv }));
          setPendingReviews(nextPending);
          try {
            console.log(
              '[initialDataCleaning] pendingReviews size after set:',
              nextPending.length
            );
          } catch (e) {}

          setCurrentStep(4); // 直接進入審核步驟示範
        };

        const handleReviewDecision = (type) => {
          // Demo：移動 index
          if (currentReviewIndex < pendingReviews.length - 1) {
            setCurrentReviewIndex((i) => i + 1);
          } else {
            setCurrentStep(5);
          }
        };

        const currentInvoice =
          pendingReviews[currentReviewIndex] || {};

        return (
          <div className="max-w-5xl mx-auto">
            <div className="bg-white rounded-lg p-4 shadow">
              <h1 className="text-lg font-semibold mb-4">發票明細審核 Demo</h1>

              {/* Step 1：上傳檔案 */}
              <div className="mb-4">
                <label className="text-xs text-gray-700 block mb-1">
                  上傳 Excel（含 Invoice / Invoice_details 或 btb411w_xls1 / btb411w_xls2）
                </label>
                <input
                  type="file"
                  accept=".xlsx,.xls"
                  onChange={handleFile}
                  className="text-xs"
                />
              </div>

              {/* Step 4：審核畫面 */}
              {currentStep === 4 && (
                <>
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    {/* 左側 - 當前審核 */}
                    <div className="bg-white rounded-lg p-4 border">
                      <h3 className="text-sm font-medium text-gray-800 mb-2">
                        審核中發票
                      </h3>
                      <div className="text-xs text-gray-600 mb-2">
                        發票號碼：{currentInvoice.invoiceNumber || '—'}
                      </div>

                      <div className="mb-3">
                        <label className="block text-xs font-medium text-gray-700 mb-2">
                          發票商品明細
                        </label>
                        <div
                          className="space-y-2 overflow-y-auto bg-gray-50 rounded p-2"
                          style={{ height: '240px' }}
                        >
                          {console.log(
                            '[UI] Step4 items len:',
                            currentInvoice?.consolidatedItemDetails?.length
                          )}
                          <ItemDetailsList
                            items={currentInvoice?.consolidatedItemDetails}
                          />
                        </div>
                      </div>

                      {/* 關鍵字（選填） */}
                      <div className="mb-4">
                        <div className="flex items-center justify-between mb-2">
                          <label className="block text-xs font-medium text-gray-700">
                            新增關鍵字（選填）
                          </label>
                          <div className="flex items-center gap-2">
                            <span className="text-[10px] text-gray-400">
                              可用於搜尋/歸戶
                            </span>
                          </div>
                        </div>
                        <input
                          type="text"
                          placeholder="輸入關鍵字後 Enter"
                          className="w-full text-xs border rounded px-2 py-1"
                          onKeyDown={(e) => {
                            if (e.key === 'Enter') e.currentTarget.value = '';
                          }}
                        />
                      </div>

                      {/* 決策按鈕列 */}
                      <div className="h-12 flex gap-3 items-center flex-shrink-0">
                        <button
                          onClick={() => handleReviewDecision('deductible')}
                          className="flex-1 bg-green-500 text-white px-4 py-2 text-xs rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2"
                        >
                          可扣抵
                        </button>
                        <button
                          onClick={() => handleReviewDecision('non-deductible')}
                          className="flex-1 bg-amber-500 text-white px-4 py-2 text-xs rounded-lg hover:bg-amber-600 transition-colors"
                        >
                          不可扣抵
                        </button>
                      </div>
                    </div>

                    {/* 右側 - 待審核清單 */}
                    <div className="lg:col-span-2 bg-white rounded-lg p-4 border">
                      <h3 className="text-sm font-medium text-gray-800 mb-2">
                        待審核清單
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {pendingReviews.map((inv, i) => (
                          <div
                            key={i}
                            className={`rounded border p-2 ${
                              i === currentReviewIndex
                                ? 'border-blue-400'
                                : 'border-gray-200'
                            }`}
                          >
                            <div className="text-xs text-gray-800">
                              {inv.invoiceNumber || '—'}
                            </div>
                            <div className="text-[10px] text-gray-400">
                              明細數：{inv?.consolidatedItemDetails?.length || 0}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </>
              )}

              {/* Step 5：完成頁 */}
              {currentStep === 5 && (
                <>
                  <h3 className="text-sm font-medium text-gray-800 mb-2">
                    審核完成
                  </h3>
                  <div className="space-y-2">
                    {pendingReviews.map((inv, idx) => (
                      <div
                        key={idx}
                        className="bg-white rounded-lg p-3 border space-y-1"
                      >
                        <div className="text-xs text-gray-700">
                          發票號碼：{inv.invoiceNumber || '—'}
                        </div>
                        <h4 className="text-xs font-medium text-gray-700 mb-1">
                          商品明細：
                        </h4>
                        <div className="space-y-1">
                          {console.log(
                            '[UI] Step5 items len:',
                            inv?.consolidatedItemDetails?.length
                          )}
                          <ItemDetailsList
                            items={inv?.consolidatedItemDetails}
                          />
                        </div>
                      </div>
                    ))}
                  </div>
                </>
              )}
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
