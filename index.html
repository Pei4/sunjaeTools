<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>發票明細審核</title>
    <!-- Tailwind (CDN 版本；若上 Production，建議用 CLI 或 PostCSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React / ReactDOM / Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <!-- SheetJS -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div id="root" class="p-4"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;
      console.log('[boot] inline app script loaded');

      // -------- Helpers (不使用 ?? 與 ?.) --------
      function normalizeAmount(v) {
        var s = String(v == null ? '' : v)
          .replace(/,/g, '')
          .replace(/\s+/g, '')
          .replace(/^NT\$?/i, '')
          .replace(/元$/i, '');
        var n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }
      function isInvoiceSheet(name) {
        return /^(invoice|btb411w_xls1)$/i.test(String(name).trim());
      }
      function isDetailSheet(name) {
        return /^(invoice_details|btb411w_xls2)$/i.test(String(name).trim());
      }

      // 專用元件：安全渲染清單，避免相鄰 JSX
      function ItemDetailsList(props) {
        var items = props && props.items ? props.items : [];
        try {
          console.log('[ItemDetailsList] received:', {
            len: items.length,
            sample: items.slice(0, 3),
          });
        } catch (e) {}
        if (!items.length) {
          return (
            <div className="text-gray-400 italic text-xs">無商品資料</div>
          );
        }
        return (
          <div>
            {items.map(function(it, i) {
              var amt =
                (it && typeof it.amount === 'number' && isFinite(it.amount))
                  ? it.amount
                  : normalizeAmount(it && it.originalRow ? it.originalRow[7] : undefined);
              return (
                <div
                  key={i}
                  className="bg-gray-50 px-2 py-1 rounded text-xs text-gray-800 flex items-center justify-between"
                >
                  <span>{(it && it.name) ? it.name : '(無品名)'}</span>
                  <span>{Number(amt || 0).toLocaleString()}</span>
                </div>
              );
            })}
          </div>
        );
      }

      // -------- XLSX 讀取 --------
      async function readFileToWorkbook(file) {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        try {
          console.log('[xlsx] SheetNames:', workbook.SheetNames);
        } catch (e) {}
        return workbook;
      }

      function readExcelSheet(sheetName, sheet) {
        console.log('[readExcelSheet] enter:', sheetName);
        var json = XLSX.utils.sheet_to_json(sheet, { header: 1 }) || [];
        var rows = json.slice(1); // 跳過標題列
        console.log(
          '[readExcelSheet] rows:',
          rows.length,
          'first row sample:',
          rows[0]
        );

        if (isInvoiceSheet(sheetName)) {
          var processedInv = rows
            .map(function(row, idx) {
              return {
                invoiceNumber: row[0] || '',
                buyerNote: row[1] || '',
                sellerId: String(row[7] || ''),
                sellerName: row[8] || '',
                originalRow: row,
                rowIndex: idx + 2,
              };
            })
            .filter(function(x) { return x.invoiceNumber; });
          console.log(
            '[readExcelSheet] INVOICE processed size:',
            processedInv.length,
            'sample:',
            processedInv.slice(0, 3)
          );
          return { type: 'invoice', rows: processedInv };
        }

        if (isDetailSheet(sheetName)) {
          var processedDet = rows
            .map(function(row, idx) {
              return {
                invoiceNumber: row[0] || '',
                itemName: row[3] || '',
                amount: normalizeAmount(row[7]), // H 欄金額
                originalRow: row,
                rowIndex: idx + 2,
              };
            })
            .filter(function(it) {
              return String(it.invoiceNumber || '').trim() &&
                     String(it.itemName || '').trim();
            });
          console.log(
            '[readExcelSheet] DETAIL processed size:',
            processedDet.length,
            'sample:',
            processedDet.slice(0, 5)
          );
          return { type: 'detail', rows: processedDet };
        }

        console.warn(
          '[readExcelSheet] unknown sheet:',
          sheetName,
          'fallback=DETAIL parser'
        );
        var fallback = rows
          .map(function(row, idx) {
            return {
              invoiceNumber: row[0] || '',
              itemName: row[3] || '',
              amount: normalizeAmount(row[7]),
              originalRow: row,
              rowIndex: idx + 2,
            };
          })
          .filter(function(it) {
            return String(it.invoiceNumber || '').trim() &&
                   String(it.itemName || '').trim();
          });
        console.log(
          '[readExcelSheet] DETAIL fallback size:',
          fallback.length,
          'sample:',
          fallback.slice(0, 5)
        );
        return { type: 'detail', rows: fallback };
      }

      // -------- 清洗與彙總 --------
      function buildConsolidated(items) {
        var m = new Map();
        for (var i = 0; i < items.length; i++) {
          var it = items[i];
          var name = String((it && it.name) ? it.name : '').trim();
          if (!name) continue;
          var amt =
            (it && typeof it.amount === 'number' && isFinite(it.amount))
              ? it.amount
              : 0;
          m.set(name, (m.get(name) || 0) + amt);
        }
        var out = [];
        m.forEach(function(amount, name) {
          out.push({ name: name, amount: amount });
        });
        return out;
      }

      function initialDataCleaning(invoiceData, invoiceDetailsData) {
        // 依發票號碼 group 明細
        var detailsByInv = new Map();
        var det = Array.isArray(invoiceDetailsData) ? invoiceDetailsData : [];
        for (var i = 0; i < det.length; i++) {
          var d = det[i];
          var key = String((d && d.invoiceNumber) ? d.invoiceNumber : '').trim();
          if (!key) continue;
          if (!detailsByInv.has(key)) detailsByInv.set(key, []);
          detailsByInv.get(key).push(d);
        }

        var invs = Array.isArray(invoiceData) ? invoiceData : [];
        var cleaned = invs.map(function(inv) {
          var invNo = String((inv && inv.invoiceNumber) ? inv.invoiceNumber : '').trim();
          var rawDetails = detailsByInv.get(invNo) || [];

          var invItemDetails = rawDetails
            .map(function(d) {
              var fallback7 = (d && d.originalRow) ? d.originalRow[7] : undefined;
              return {
                name: d ? d.itemName : '',
                amount: (d && typeof d.amount === 'number' && isFinite(d.amount))
                  ? d.amount
                  : normalizeAmount(fallback7),
                originalRow: d ? d.originalRow : undefined
              };
            })
            .filter(function(it) { return it.name; });

          var invItems = invItemDetails.map(function(it){ return it.name; });
          var consolidatedItemDetails = buildConsolidated(invItemDetails);

          try {
            console.log(
              '[initialDataCleaning] invNumber:',
              invNo,
              'rawDetails size:',
              rawDetails.length,
              'itemDetails sample:',
              invItemDetails.slice(0, 5),
              'consolidated size:',
              consolidatedItemDetails.length
            );
          } catch (e) {}

          return {
            invoiceNumber: invNo,
            buyerNote: (inv && inv.buyerNote) ? inv.buyerNote : '待查',
            sellerId: inv && inv.sellerId ? inv.sellerId : '',
            sellerName: inv && inv.sellerName ? inv.sellerName : '',
            items: invItems,
            consolidatedItems: Array.from(new Set(invItems)),
            consolidatedItemDetails: consolidatedItemDetails
          };
        });

        return cleaned;
      }

      // -------- App --------
      function App() {
        const [workbook, setWorkbook] = useState(null);
        const [invoiceData, setInvoiceData] = useState([]);
        const [invoiceDetailsData, setInvoiceDetailsData] = useState([]);
        const [pendingReviews, setPendingReviews] = useState([]);
        const [currentReviewIndex, setCurrentReviewIndex] = useState(0);
        const [currentStep, setCurrentStep] = useState(1);

        const handleFile = async (e) => {
          const file = e.target.files && e.target.files[0] ? e.target.files[0] : null;
          if (!file) return;
          const wb = await readFileToWorkbook(file);
          setWorkbook(wb);

          var invRows = [];
          var detRows = [];
          for (var s = 0; s < wb.SheetNames.length; s++) {
            var sheetName = wb.SheetNames[s];
            try {
              console.log(
                '[xlsx] dispatch ->',
                sheetName,
                'isInvoice?',
                isInvoiceSheet(sheetName),
                'isDetail?',
                isDetailSheet(sheetName)
              );
            } catch (e) {}
            var sheet = wb.Sheets[sheetName];
            var res = readExcelSheet(sheetName, sheet);
            if (res.type === 'invoice') invRows = invRows.concat(res.rows);
            if (res.type === 'detail') detRows = detRows.concat(res.rows);
          }
          setInvoiceData(invRows);
          setInvoiceDetailsData(detRows);

          var cleaned = initialDataCleaning(invRows, detRows);
          var nextPending = cleaned.map(function(inv){ return inv; });
          setPendingReviews(nextPending);
          try {
            console.log(
              '[initialDataCleaning] pendingReviews size after set:',
              nextPending.length
            );
          } catch (e) {}

          setCurrentStep(4); // 直接示範進入 Step 4
        };

        function handleReviewDecision(type) {
          if (currentReviewIndex < pendingReviews.length - 1) {
            setCurrentReviewIndex(function(i){ return i + 1; });
          } else {
            setCurrentStep(5);
          }
        }

        var currentInvoice = pendingReviews[currentReviewIndex] || {};

        return (
          <div className="max-w-5xl mx-auto">
            <div className="bg-white rounded-lg p-4 shadow">
              <h1 className="text-lg font-semibold mb-4">發票明細審核 Demo</h1>

              {/* Step 1：上傳檔案 */}
              <div className="mb-4">
                <label className="text-xs text-gray-700 block mb-1">
                  上傳 Excel（含 Invoice / Invoice_details 或 btb411w_xls1 / btb411w_xls2）
                </label>
                <input
                  type="file"
                  accept=".xlsx,.xls"
                  onChange={handleFile}
                  className="text-xs"
                />
              </div>

              {/* Step 4：審核畫面 */}
              {currentStep === 4 && (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                  {/* 左側 - 當前審核 */}
                  <div className="bg-white rounded-lg p-4 border">
                    <h3 className="text-sm font-medium text-gray-800 mb-2">
                      審核中發票
                    </h3>
                    <div className="text-xs text-gray-600 mb-2">
                      發票號碼：{currentInvoice.invoiceNumber || '—'}
                    </div>

                    <div className="mb-3">
                      <label className="block text-xs font-medium text-gray-700 mb-2">
                        發票商品明細
                      </label>
                      <div
                        className="space-y-2 overflow-y-auto bg-gray-50 rounded p-2"
                        style={{ height: '240px' }}
                      >
                        {console.log(
                          '[UI] Step4 items len:',
                          (currentInvoice && currentInvoice.consolidatedItemDetails)
                            ? currentInvoice.consolidatedItemDetails.length
                            : undefined
                        )}
                        <ItemDetailsList
                          items={
                            currentInvoice && currentInvoice.consolidatedItemDetails
                              ? currentInvoice.consolidatedItemDetails
                              : []
                          }
                        />
                      </div>
                    </div>

                    {/* 關鍵字（選填） */}
                    <div className="mb-4">
                      <div className="flex items-center justify-between mb-2">
                        <label className="block text-xs font-medium text-gray-700">
                          新增關鍵字（選填）
                        </label>
                        <div className="flex items-center gap-2">
                          <span className="text-[10px] text-gray-400">
                            可用於搜尋/歸戶
                          </span>
                        </div>
                      </div>
                      <input
                        type="text"
                        placeholder="輸入關鍵字後 Enter"
                        className="w-full text-xs border rounded px-2 py-1"
                        onKeyDown={function(e){
                          if (e.key === 'Enter') e.currentTarget.value = '';
                        }}
                      />
                    </div>

                    {/* 決策按鈕列 */}
                    <div className="h-12 flex gap-3 items-center flex-shrink-0">
                      <button
                        onClick={function(){ handleReviewDecision('deductible'); }}
                        className="flex-1 bg-green-500 text-white px-4 py-2 text-xs rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2"
                      >
                        可扣抵
                      </button>
                      <button
                        onClick={function(){ handleReviewDecision('non-deductible'); }}
                        className="flex-1 bg-amber-500 text-white px-4 py-2 text-xs rounded-lg hover:bg-amber-600 transition-colors"
                      >
                        不可扣抵
                      </button>
                    </div>
                  </div>

                  {/* 右側 - 待審核清單 */}
                  <div className="lg:col-span-2 bg-white rounded-lg p-4 border">
                    <h3 className="text-sm font-medium text-gray-800 mb-2">
                      待審核清單
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                      {pendingReviews.map(function(inv, i) {
                        return (
                          <div
                            key={i}
                            className={
                              'rounded border p-2 ' +
                              (i === currentReviewIndex ? 'border-blue-400' : 'border-gray-200')
                            }
                          >
                            <div className="text-xs text-gray-800">
                              {inv.invoiceNumber || '—'}
                            </div>
                            <div className="text-[10px] text-gray-400">
                              明細數：{(inv && inv.consolidatedItemDetails) ? inv.consolidatedItemDetails.length : 0}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}

              {/* Step 5：完成頁 */}
              {currentStep === 5 && (
                <div>
                  <h3 className="text-sm font-medium text-gray-800 mb-2">
                    審核完成
                  </h3>
                  <div className="space-y-2">
                    {pendingReviews.map(function(inv, idx) {
                      return (
                        <div
                          key={idx}
                          className="bg-white rounded-lg p-3 border space-y-1"
                        >
                          <div className="text-xs text-gray-700">
                            發票號碼：{inv.invoiceNumber || '—'}
                          </div>
                          <h4 className="text-xs font-medium text-gray-700 mb-1">
                            商品明細：
                          </h4>
                          <div className="space-y-1">
                            {console.log(
                              '[UI] Step5 items len:',
                              (inv && inv.consolidatedItemDetails) ? inv.consolidatedItemDetails.length : undefined
                            )}
                            <ItemDetailsList
                              items={(inv && inv.consolidatedItemDetails) ? inv.consolidatedItemDetails : []}
                            />
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
