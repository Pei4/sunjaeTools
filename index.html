<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>進項扣抵審核工具（修正版）</title>
  <!-- 開發用 CDN（若要 Production 最佳化，可改打包編譯） -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .container-narrow { width: 100%; }
    @media (min-width: 1024px){ .container-narrow { width: 880px; margin: 0 auto; } }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace }
    details > summary { cursor: pointer; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo } = React;

    // ========= n8n API =========
    const N8N_BASE = "https://pei4.zeabur.app";
    const urlParams = new URLSearchParams(window.location.search);
    const N8N_KEY = urlParams.get("key");
    function assertKey(){ if(!N8N_KEY) throw new Error("缺少 X-API-Key：請在網址加上 ?key=你的金鑰"); }
    function str(x){ return (x==null?"":String(x)).trim(); }
    function idxOf(headers, candidates, fallbackIdx = -1){
      const set = new Set(headers.map(String));
      for(const c of candidates) if(set.has(c)) return headers.indexOf(c);
      return fallbackIdx;
    }

    function normalizeRefArray(raw){
      const arr = Array.isArray(raw) ? raw : (raw?.data ?? raw?.rows ?? []);
      if(!Array.isArray(arr)) return [];
      return arr.map(x=>{
        const o = (x && typeof x==='object') ? x : {};
        const customerId = str(o.customerId ?? o.customerID ?? o.cid ?? o.customer ?? "");
        const sellerId   = str(o.sellerId ?? o.sellerID ?? o.seller ?? o.vendorId ?? "");
        const keyword    = str(o.keyword ?? o.kw ?? o.key ?? "");
        let ded = o.deductable ?? o.deductible ?? o.allowed ?? o.isAllowed ?? o.canDeduct ?? "";
        ded = str(ded).toLowerCase();
        const yes = (ded==="yes"||ded==="y"||ded==="true"||ded==="1");
        const no  = (ded==="no" ||ded==="n"||ded==="false"||ded==="0");
        const deductable = yes ? "Yes" : (no ? "No" : (str(o.deductable)==="Yes"?"Yes":"No"));
        return { customerId, deductable, sellerId, keyword };
      });
    }

    async function fetchRefDataFromN8n(customerId){
      assertKey();
      const url = `${N8N_BASE}/webhook/get-ref-data?customerId=${encodeURIComponent(customerId)}`;
      const res = await fetch(url, { method:"GET", headers:{ "X-API-Key": N8N_KEY }, mode:"cors", credentials:"omit" });
      const text = await res.text().catch(()=> "");
      if(!res.ok) throw new Error(`n8n 讀取失敗 ${res.status} ${text}`);
      try{ return JSON.parse(text); }catch{ return []; }
    }
    async function addRefRuleToN8n(rule){
      assertKey();
      const url = `${N8N_BASE}/webhook/add-ref-data`;
      const res = await fetch(url, { method:"POST", headers:{ "X-API-Key": N8N_KEY, "Content-Type":"application/json" }, body: JSON.stringify(rule) });
      const text = await res.text().catch(()=> "");
      if(!res.ok) throw new Error(`n8n 寫入失敗 ${res.status} ${text}`);
      try{ return JSON.parse(text); }catch{ return text; }
    }

    function App(){
      // ===== 狀態 =====
      const [step, setStep] = useState(1);
      const [companyId, setCompanyId] = useState("");
      const [error, setError] = useState("");
      const [progress, setProgress] = useState(0);

      const [invHeaders, setInvHeaders] = useState([]);
      const [detHeaders, setDetHeaders] = useState([]);
      const [invRowsAOA, setInvRowsAOA] = useState([]);
      const [detRowsAOA, setDetRowsAOA] = useState([]);

      const [invoices, setInvoices] = useState([]);
      const [details, setDetails] = useState([]);

      const [rawRefResponse, setRawRefResponse] = useState(null);
      const [refRules, setRefRules] = useState([]);
      const [pending, setPending] = useState([]);
      const [cursor, setCursor] = useState(0);

      const [newKeyword, setNewKeyword] = useState("");
      const [includeSellerId, setIncludeSellerId] = useState(false);
      const [addedRules, setAddedRules] = useState([]);

      // 統計（保險：若 invoices 還沒更新，就用 invRowsAOA 的筆數顯示總數）
      const counters = useMemo(()=>({
        total: (invoices.length || invRowsAOA.length),
        pending: invoices.filter(v=>v.buyerNote==="待查").length,
        yes: invoices.filter(v=>v.buyerNote==="").length,
        no: invoices.filter(v=>v.buyerNote==="不得抵扣之進貨及費用").length,
      }), [invoices, invRowsAOA]);

      // ===== 檔案讀取 =====
      async function readSheet(file, sheetName){
        return new Promise((resolve, reject)=>{
          const reader = new FileReader();
          reader.onload = (e)=>{
            try{
              const wb = XLSX.read(new Uint8Array(e.target.result), { type:"array" });
              if(!wb.SheetNames.includes(sheetName)) { reject(new Error(`找不到工作表: ${sheetName}`)); return; }
              const ws = wb.Sheets[sheetName];
              const aoa = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
              if(!aoa.length) { reject(new Error(`${sheetName} 無資料`)); return; }
              const headers = aoa[0].map(v=>str(v));
              const rows = aoa.slice(1);
              resolve({ headers, rows });
            }catch(err){ reject(err); }
          };
          reader.onerror = ()=> reject(new Error("檔案讀取失敗"));
          reader.readAsArrayBuffer(file);
        });
      }

      async function onUpload(e){
        try{
          setError("");
          const file = e.target.files?.[0];
          if(!file) return;
          if(!file.name.endsWith(".xlsx")) { setError("請上傳 .xlsx 檔案"); return; }

          const cid = file.name.slice(0,8);
          setCompanyId(cid);

          const inv = await readSheet(file, "Invoice");
          const det = await readSheet(file, "Invoice_details");

          setInvHeaders(inv.headers);
          setDetHeaders(det.headers);
          setInvRowsAOA(inv.rows);
          setDetRowsAOA(det.rows);

          // 欄位索引（容錯）
          const colInvoiceNumber = idxOf(inv.headers, ["發票號碼","InvoiceNumber"], 0);
          const colBuyerNote     = idxOf(inv.headers, ["買受人註記","buyerNote"], 1);
          const colSellerId      = idxOf(inv.headers, ["賣方統一編號","賣方統編","SellerId","SellerID"], 7);
          const colDetInvNum     = idxOf(det.headers, ["發票號碼","InvoiceNumber"], 0);
          const colDetItemName   = idxOf(det.headers, ["品名","ItemName"], 3);

          const detailsStruct = det.rows.map((r,i)=>({
            idx:i, row:r,
            invoiceNumber: str(r[colDetInvNum]),
            itemName: str(r[colDetItemName]),
          })).filter(d=>d.invoiceNumber && d.itemName);

          const invoicesStruct = inv.rows.map((r,i)=>({
            idx:i, row:r,
            buyerNoteCol: colBuyerNote>=0? colBuyerNote : 1,
            invoiceNumber: str(r[colInvoiceNumber]),
            sellerId: str(r[colSellerId]),
            buyerNote: str(r[colBuyerNote]),
            items: [],
          })).filter(v=>v.invoiceNumber);

          setDetails(detailsStruct);
          setInvoices(invoicesStruct);

          setStep(2);
          setTimeout(()=> loadRef(cid), 100);
        }catch(err){
          setError(err.message || String(err));
        }
      }

      // 測試資料
      function loadDemo(){
        setError("");
        const invH = ["發票號碼","買受人註記","格式代號","發票狀態","發票日期","買方統一編號","買方名稱","賣方統一編號","賣方名稱"];
        const invR = [
          ["AB12345678","","","","2025-08-01","87097348","某公司","27365925","某供應商"],
          ["CD87654321","","","","2025-08-02","87097348","某公司","00000000","餐廳A"],
          ["EF00000001","","","","2025-08-03","87097348","某公司","52003801","供應商B"],
        ];
        const detH = ["發票號碼","發票日期","序號","品名","數量","單位","單價","金額"];
        const detR = [
          ["AB12345678","2025-08-01",1,"面膜-極潤",1,"盒",100,100],
          ["AB12345678","2025-08-01",2,"防曬乳",1,"條",200,200],
          ["CD87654321","2025-08-02",1,"餐飲消費",1,"次",500,500],
          ["EF00000001","2025-08-03",1,"雜項",1,"項",50,50]
        ];
        setCompanyId("87097348");
        setInvHeaders(invH); setDetHeaders(detH);
        setInvRowsAOA(invR); setDetRowsAOA(detR);

        const invoicesStruct = invR.map((r,i)=>({
          idx:i, row:r, buyerNoteCol:1,
          invoiceNumber: str(r[0]),
          sellerId: str(r[7]),
          buyerNote: str(r[1]),
          items:[]
        }));
        const detailsStruct = detR.map((r,i)=>({
          idx:i, row:r,
          invoiceNumber: str(r[0]),
          itemName: str(r[3]),
        }));
        setInvoices(invoicesStruct);
        setDetails(detailsStruct);

        const demoRules = [
          { customerId:"87097348", deductable:"Yes", sellerId:"27365925", keyword:"面膜" },
          { customerId:"87097348", deductable:"Yes", sellerId:"27365925", keyword:"防曬" },
          { customerId:"87097348", deductable:"No",  sellerId:"",        keyword:"餐飲" },
          { customerId:"87097348", deductable:"Yes", sellerId:"52003801", keyword:"" },
        ];
        setRawRefResponse(demoRules);
        setRefRules(demoRules);

        setStep(3);
        setTimeout(()=> doCleaning(demoRules), 150);
      }

      async function loadRef(cid){
        try{
          const raw = await fetchRefDataFromN8n(cid);
          setRawRefResponse(raw);
          const rules = normalizeRefArray(raw).filter(r => r.customerId===cid || r.customerId==="");
          setRefRules(rules);
          setStep(3);
          setTimeout(()=> doCleaning(rules), 100);
        }catch(err){
          setError(err.message || String(err));
          setRawRefResponse({ error: err.message });
          setRefRules([]);
          setStep(3);
          setTimeout(()=> doCleaning([]), 100);
        }
      }

      // ===== 初步清理（修正：先寫入狀態，下一拍再切步驟） =====
      function doCleaning(refs){
        setProgress(0);

        // invoiceNumber => items[]
        const itemsMap = new Map();
        for(const d of details){
          const arr = itemsMap.get(d.invoiceNumber) || [];
          arr.push(d.itemName);
          itemsMap.set(d.invoiceNumber, arr);
        }

        const t = setInterval(()=>{
          setProgress(p=>{
            if(p>=100){
              clearInterval(t);

              const next = invoices.map(v=>{
                const items = itemsMap.get(v.invoiceNumber) || [];
                const note = judge(v.sellerId, items, refs);
                return { ...v, items, buyerNote: note };
              });

              setInvoices(next);

              const pend = next.filter(x=> x.buyerNote==="待查").map(x=>x.idx);
              setPending(pend);
              setCursor(0);

              // 修正點：等本次 state 寫入排隊後，再切換步驟，避免讀到舊
              setTimeout(()=> {
                setStep(pend.length ? 4 : 5);
              }, 0);

              return 100;
            }
            return p + 20;
          });
        }, 150);
      }

      function judge(sellerId, items, refs){
        const seller = str(sellerId);
        const hasYes = refs.some(r =>
          r.deductable==="Yes" &&
          ((str(r.sellerId) && str(r.sellerId)===seller) || (str(r.keyword) && items.some(it=>it.includes(str(r.keyword)))))
        );
        if(hasYes) return "";
        const hasNo = refs.some(r =>
          r.deductable==="No" &&
          ((str(r.sellerId) && str(r.sellerId)===seller) || (str(r.keyword) && items.some(it=>it.includes(str(r.keyword)))))
        );
        if(hasNo) return "不得抵扣之進貨及費用";
        return "待查";
      }

      // ===== 人工審核 =====
      function commit(decision){
        if(!pending.length) return;
        const invIdx = pending[cursor];
        const v = invoices.find(x=>x.idx===invIdx);
        if(!v) return;
        const newNote = decision==="yes" ? "" : "不得抵扣之進貨及費用";
        setInvoices(prev => prev.map(x => x.idx===invIdx ? { ...x, buyerNote:newNote } : x));

        const kw = newKeyword.trim();
        if(kw){
          const rule = { customerId: companyId, deductable: decision==="yes" ? "Yes":"No", sellerId: includeSellerId ? v.sellerId : "", keyword: kw };
          setAddedRules(prev=>[...prev, rule]);
          setRefRules(prev=>[...prev, rule]);
          addRefRuleToN8n(rule).catch(()=>{});
          setNewKeyword(""); setIncludeSellerId(false);
        }

        if(cursor < pending.length-1) setCursor(c=>c+1);
        else setStep(5);
      }

      async function finalize(){
        for(const r of addedRules){ try{ await addRefRuleToN8n(r); }catch(e){} }
        setStep(6);
      }

      // ===== 匯出（只覆蓋「買受人註記」） =====
      function downloadExcel(){
        let buyerNoteCol = idxOf(invHeaders, ["買受人註記","buyerNote"], 1);
        const byIdx = new Map(invoices.map(v => [v.idx, v]));
        const updatedInvRows = invRowsAOA.map((row,i)=>{
          const v = byIdx.get(i);
          if(!v) return row.slice();
          const newRow = row.slice();
          newRow[buyerNoteCol] = v.buyerNote;
          return newRow;
        });

        const wb = XLSX.utils.book_new();
        const invAoa = [invHeaders, ...updatedInvRows];
        const detAoa = [detHeaders, ...detRowsAOA];
        const invWs = XLSX.utils.aoa_to_sheet(invAoa);
        const detWs = XLSX.utils.aoa_to_sheet(detAoa);
        XLSX.utils.book_append_sheet(wb, invWs, "Invoice");
        XLSX.utils.book_append_sheet(wb, detWs, "Invoice_details");
        const stamp = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `${companyId}_${stamp}_reviewed.xlsx`);
      }

      // ===== UI =====
      return (
        <div className="container-narrow px-4 py-6">
          <h1 className="text-xl font-bold mb-4">進項扣抵審核工具</h1>

          {error && (
            <div className="mb-4 p-3 rounded bg-red-50 border border-red-200 text-sm text-red-800">{error}</div>
          )}

          <details className="mb-4">
            <summary className="text-sm text-gray-700">顯示偵錯資訊</summary>
            <div className="mt-3 text-xs text-gray-800 bg-white rounded border p-3 space-y-2">
              <p>Step: {step} / CompanyId: <span className="mono">{companyId||"-"}</span></p>
              <p>Invoice：headers {invHeaders.length} 欄、rows {invRowsAOA.length} 筆；Details：headers {detHeaders.length} 欄、rows {detRowsAOA.length} 筆</p>
              <p>Invoices struct：{invoices.length}；Details struct：{details.length}</p>
              <p>Rules：{refRules.length}；本次新增規則：{addedRules.length}</p>
              <p>統計：總發票 {counters.total}、待查 {counters.pending}、可扣抵 {counters.yes}、不可扣抵 {counters.no}</p>
              <div><b>Invoice headers</b><pre className="bg-gray-50 p-2 rounded">{JSON.stringify(invHeaders, null, 2)}</pre></div>
              <div><b>Details headers</b><pre className="bg-gray-50 p-2 rounded">{JSON.stringify(detHeaders, null, 2)}</pre></div>
            </div>
          </details>

          <div className="w-full bg-gray-200 h-1 mb-4 rounded">
            <div className="bg-blue-600 h-1 rounded transition-all" style={{ width: `${(step/6)*100}%` }} />
          </div>

          {step===1 && (
            <div className="bg-white rounded-xl shadow p-5">
              <p className="text-sm text-gray-600 mb-3">上傳包含 <span className="mono">Invoice</span> 與 <span className="mono">Invoice_details</span> 的 Excel（檔名前 8 碼為客戶統編）。</p>
              <div className="flex items-center gap-3">
                <input type="file" accept=".xlsx" onChange={onUpload} className="block text-sm"/>
                <button onClick={loadDemo} className="px-3 py-2 text-sm bg-gray-100 rounded hover:bg-gray-200">使用測試資料</button>
              </div>
              {companyId && <p className="text-xs text-gray-500 mt-3">偵測到統編：<span className="mono">{companyId}</span></p>}
            </div>
          )}

          {step===2 && (
            <div className="bg-white rounded-xl shadow p-6 text-center">
              <div className="animate-spin mx-auto mb-3 rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
              <p className="text-sm text-gray-700">正在載入 <span className="mono">{companyId}</span> 的參考規則...</p>
            </div>
          )}

          {step===3 && (
            <div className="bg-white rounded-xl shadow p-6 text-center">
              <h2 className="font-semibold mb-3">初步資料清理</h2>
              <div className="w-full bg-gray-200 rounded-full h-2 mb-3">
                <div className="bg-blue-600 h-2 rounded-full" style={{ width: `${progress}%` }} />
              </div>
              <p className="text-sm text-gray-600">{progress}%</p>
            </div>
          )}

          {step===4 && (
            <div className="bg-white rounded-xl shadow p-5">
              <h2 className="font-semibold mb-4">逐筆審核（待查）</h2>
              {pending.length===0 ? (
                <p className="text-sm text-gray-600">沒有待查項目。</p>
              ) : (
                <>
                  {(() => {
                    const invIdx = pending[cursor];
                    const v = invoices.find(x=>x.idx===invIdx);
                    if(!v) return <p className="text-sm text-gray-600">資料錯誤，找不到對應發票。</p>;
                    return (
                      <div className="space-y-2 mb-4 text-sm">
                        <p><b>發票號碼：</b><span className="mono">{v.invoiceNumber}</span></p>
                        <p><b>賣方統編：</b><span className="mono">{v.sellerId || "-"}</span></p>
                        <p><b>明細：</b>{v.items.length ? v.items.join("、") : "-"}</p>
                      </div>
                    );
                  })()}
                  <div className="mb-3">
                    <input value={newKeyword} onChange={e=>setNewKeyword(e.target.value)} placeholder="新增關鍵字（可多筆，用逗號分隔）" className="w-full border rounded px-3 py-2 text-sm"/>
                    <label className="text-sm mt-2 inline-flex items-center gap-2">
                      <input type="checkbox" checked={includeSellerId} onChange={e=>setIncludeSellerId(e.target.checked)} /> 同步包含賣方統編
                    </label>
                  </div>
                  <div className="flex gap-3">
                    <button onClick={()=>commit("yes")} className="flex-1 rounded bg-green-600 text-white py-2 text-sm hover:bg-green-700">可扣抵</button>
                    <button onClick={()=>commit("no")}  className="flex-1 rounded bg-red-600 text-white py-2 text-sm hover:bg-red-700">不可扣抵</button>
                  </div>
                  <p className="text-xs text-gray-500 mt-3">進度：{cursor+1}/{pending.length}</p>
                </>
              )}
            </div>
          )}

          {step===5 && (
            <div className="bg-white rounded-xl shadow p-5 text-center space-y-3">
              <h2 className="font-semibold">審核完成</h2>
              <div className="flex flex-col sm:flex-row gap-3 justify-center">
                <button onClick={finalize} className="px-4 py-2 rounded bg-blue-600 text-white text-sm hover:bg-blue-700">確認完成並送出 n8n</button>
                <button onClick={downloadExcel} className="px-4 py-2 rounded bg-emerald-600 text-white text-sm hover:bg-emerald-700">下載 Excel 結果</button>
              </div>
              <div className="mt-4 p-3 bg-gray-50 rounded border text-left text-xs text-gray-700">
                <p>總發票：{counters.total}，待查：{counters.pending}，可扣抵：{counters.yes}，不可扣抵：{counters.no}</p>
                <p>規則數：{refRules.length}，本次新增規則：{addedRules.length}</p>
              </div>
            </div>
          )}

          {step===6 && (
            <div className="bg-white rounded-xl shadow p-6 text-center">
              <p className="text-green-600 font-semibold">✅ 已完成，新增規則已送出 n8n。</p>
              <button onClick={downloadExcel} className="mt-3 px-4 py-2 rounded bg-emerald-600 text-white text-sm hover:bg-emerald-700">再次下載 Excel 結果</button>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);

    // 全域錯誤攔截（避免白畫面）
    window.addEventListener('error', e => console.error("[window.onerror]", e.message, e.filename, e.lineno, e.colno));
    window.addEventListener('unhandledrejection', e => console.error("[unhandledrejection]", e.reason));
  </script>
</body>
</html>
