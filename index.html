<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>進項扣抵審核工具</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    // --- n8n API 配置 ---
    const N8N_BASE = "https://pei4.zeabur.app";
    const urlParams = new URLSearchParams(window.location.search);
    const N8N_KEY = urlParams.get("key");
    if (!N8N_KEY) {
      alert("請在網址中提供 key，例如 ?key=你的key");
      throw new Error("Missing API key");
    }

    async function fetchRefDataFromN8n(customerId) {
      const url = `${N8N_BASE}/webhook/get-ref-data?customerId=${encodeURIComponent(customerId)}`;
      const res = await fetch(url, {
        headers: { "X-API-Key": N8N_KEY, "Content-Type": "application/json" }
      });
      if (!res.ok) throw new Error(`n8n 讀取失敗 ${res.status}`);
      return await res.json();
    }

    async function addRefRuleToN8n(rule) {
      const url = `${N8N_BASE}/webhook/add-ref-data`;
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-API-Key": N8N_KEY },
        body: JSON.stringify(rule)
      });
      if (!res.ok) throw new Error(`n8n 寫入失敗 ${res.status}`);
      return await res.json();
    }

    function InvoiceReviewSystem() {
      const [step, setStep] = useState(1);
      const [companyId, setCompanyId] = useState('');
      const [uploadedFile, setUploadedFile] = useState(null);
      const [invoiceData, setInvoiceData] = useState([]);
      const [invoiceDetailsData, setInvoiceDetailsData] = useState([]);
      const [originalInvoiceData, setOriginalInvoiceData] = useState([]);
      const [originalDetailsData, setOriginalDetailsData] = useState([]);
      const [invoiceHeaders, setInvoiceHeaders] = useState([]);
      const [detailsHeaders, setDetailsHeaders] = useState([]);
      const [refData, setRefData] = useState([]);
      const [pendingReviews, setPendingReviews] = useState([]);
      const [currentReviewIndex, setCurrentReviewIndex] = useState(0);
      const [newKeyword, setNewKeyword] = useState('');
      const [includeSellerID, setIncludeSellerID] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);
      const [progress, setProgress] = useState(0);
      const [error, setError] = useState('');
      const [newlyAddedRefData, setNewlyAddedRefData] = useState([]);

      // fallback 測試資料
      const fallbackRefData = [
        { customerId: '87097348', deductable: 'Yes', sellerId: '27365925', keyword: '面膜' },
        { customerId: '87097348', deductable: 'Yes', sellerId: '27365925', keyword: '防曬' },
        { customerId: '28152246', deductable: 'No', sellerId: '28152246', keyword: '' },
        { customerId: '28152246', deductable: 'No', sellerId: '', keyword: '餐飲' },
        { customerId: '28152246', deductable: 'No', sellerId: '', keyword: '料理' },
        { customerId: '28152246', deductable: 'Yes', sellerId: '13750574', keyword: '運什費' },
        { customerId: '28152246', deductable: 'Yes', sellerId: '52003801', keyword: '' },
        { customerId: '28152246', deductable: 'Yes', sellerId: '05386910', keyword: '' },
      ];

      // --- Excel 讀取 ---
      const handleFileUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        if (!file.name.endsWith('.xlsx')) {
          setError('請上傳 Excel 檔案（.xlsx格式）');
          return;
        }
        setError('');
        setUploadedFile(file);
        const extractedCompanyId = file.name.substring(0, 8);
        setCompanyId(extractedCompanyId);
        try {
          const invoiceSheetData = await readExcelSheet(file, 'Invoice');
          const detailsSheetData = await readExcelSheet(file, 'Invoice_details');
          setOriginalInvoiceData(invoiceSheetData.data);
          setInvoiceHeaders(invoiceSheetData.headers);
          setOriginalDetailsData(detailsSheetData.data);
          setDetailsHeaders(detailsSheetData.headers);
          setInvoiceData(invoiceSheetData.data);
          setInvoiceDetailsData(detailsSheetData.data);
          setStep(2);
          setTimeout(() => searchRefData(extractedCompanyId), 500);
        } catch (err) {
          setError('檔案讀取失敗：' + err.message);
        }
      };

      const readExcelSheet = async (file, sheetName) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              if (!workbook.SheetNames.includes(sheetName)) {
                reject(new Error('找不到工作表: ' + sheetName));
                return;
              }
              const worksheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
              const headers = jsonData[0] || [];
              const rows = jsonData.slice(1);

              const formatted = rows.map((row, i) => {
                const obj = {};
                headers.forEach((h, j) => { obj[h] = row[j] || ''; });
                obj.rowIndex = i + 2;
                return obj;
              }).filter(item => Object.values(item).some(v => v !== ''));
              resolve({ headers, data: formatted });
            } catch (err) { reject(err); }
          };
          reader.onerror = () => reject(new Error('檔案讀取失敗'));
          reader.readAsArrayBuffer(file);
        });
      };

      // --- 載入參考資料 ---
      const searchRefData = async (customerId) => {
        try {
          setIsProcessing(true);
          const n8nData = await fetchRefDataFromN8n(customerId);
          setRefData(n8nData);
          setStep(3);
          setTimeout(() => initialDataCleaning(n8nData), 100);
        } catch (e) {
          console.error("載入失敗，改用 fallback", e);
          const filtered = fallbackRefData.filter(r => r.customerId === customerId);
          setRefData(filtered);
          setStep(3);
          setTimeout(() => initialDataCleaning(filtered), 100);
        } finally {
          setIsProcessing(false);
        }
      };

      // --- 初步清理 ---
      const initialDataCleaning = (currentRefData) => {
        setIsProcessing(true);
        setProgress(0);
        const interval = setInterval(() => {
          setProgress(prev => {
            if (prev >= 100) {
              clearInterval(interval);
              setIsProcessing(false);
              const cleanedData = originalInvoiceData.map(invoice => {
                const invoiceItems = originalDetailsData
                  .filter(d => d["發票號碼"] === invoice["發票號碼"])
                  .map(d => d["品名"]);
                let note = '待查';
                if (currentRefData.some(ref => ref.deductable === 'Yes' &&
                    (ref.sellerId === invoice["賣方統編"] || invoiceItems.some(it => it.includes(ref.keyword))))) {
                  note = '';
                } else if (currentRefData.some(ref => ref.deductable === 'No' &&
                    (ref.sellerId === invoice["賣方統編"] || invoiceItems.some(it => it.includes(ref.keyword))))) {
                  note = '不得抵扣之進貨及費用';
                }
                return { ...invoice, "買受人註記": note, items: invoiceItems };
              });
              setInvoiceData(cleanedData);
              setPendingReviews(cleanedData.filter(i => i["買受人註記"] === '待查'));
              setStep(cleanedData.some(i => i["買受人註記"] === '待查') ? 4 : 5);
              return 100;
            }
            return prev + 20;
          });
        }, 200);
      };

      // --- 審核決策 ---
      const handleReviewDecision = (decision) => {
        const currentInvoice = pendingReviews[currentReviewIndex];
        const updatedData = invoiceData.map(inv =>
          inv["發票號碼"] === currentInvoice["發票號碼"]
            ? { ...inv, "買受人註記": decision === 'deductible' ? '' : '不得抵扣之進貨及費用' }
            : inv
        );
        setInvoiceData(updatedData);
        if (newKeyword.trim()) {
          const newRule = { customerId: companyId, deductable: decision === 'deductible' ? 'Yes' : 'No', sellerId: includeSellerID ? currentInvoice["賣方統編"] : '', keyword: newKeyword.trim() };
          setRefData(prev => [...prev, newRule]);
          setNewlyAddedRefData(prev => [...prev, newRule]);
          addRefRuleToN8n(newRule).catch(console.error);
          setNewKeyword('');
          setIncludeSellerID(false);
        }
        if (currentReviewIndex < pendingReviews.length - 1) setCurrentReviewIndex(i => i + 1);
        else setStep(5);
      };

      // --- 確認完成 ---
      const handleConfirmCompletion = async () => {
        for (const rule of newlyAddedRefData) {
          try { await addRefRuleToN8n(rule); } catch (e) { console.error(e); }
        }
        setStep(6);
      };

      // --- 匯出 Excel ---
      const downloadResults = () => {
        const wb = XLSX.utils.book_new();

        // Invoice 工作表 (保持原始順序，更新「買受人註記」欄位)
        const invoiceSheetData = [
          invoiceHeaders,
          ...invoiceData.map(inv =>
            invoiceHeaders.map(h => inv[h] !== undefined ? inv[h] : '')
          )
        ];
        const invoiceSheet = XLSX.utils.aoa_to_sheet(invoiceSheetData);
        XLSX.utils.book_append_sheet(wb, invoiceSheet, "Invoice");

        // Invoice_details 工作表
        const detailsSheetData = [
          detailsHeaders,
          ...originalDetailsData.map(det =>
            detailsHeaders.map(h => det[h] !== undefined ? det[h] : '')
          )
        ];
        const detailsSheet = XLSX.utils.aoa_to_sheet(detailsSheetData);
        XLSX.utils.book_append_sheet(wb, detailsSheet, "Invoice_details");

        XLSX.writeFile(wb, `${companyId}_${new Date().toISOString().slice(0,10)}_reviewed.xlsx`);
      };

      // --- UI ---
      return (
        <div className="min-h-screen bg-gray-50 py-4">
          <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-md p-6">
            <div className="w-full bg-gray-200 h-1 mb-3">
              <div className="bg-blue-500 h-1 transition-all duration-300" style={{ width: (step/6)*100+'%' }} />
            </div>

            {step === 1 && (
              <div className="text-center">
                <h2 className="text-lg font-bold mb-3">上傳發票檔案</h2>
                <input type="file" accept=".xlsx" onChange={handleFileUpload} className="mb-4" />
                {error && <p className="text-red-600 text-sm">{error}</p>}
              </div>
            )}

            {step === 2 && <p className="text-center">正在載入參考資料...</p>}

            {step === 3 && (
              <div className="text-center">
                <h2 className="text-lg font-bold mb-3">初步資料清理</h2>
                <div className="w-full bg-gray-200 rounded-full h-2 mb-3">
                  <div className="bg-blue-500 h-2 rounded-full" style={{ width: progress+'%' }} />
                </div>
                <p>{progress}%</p>
              </div>
            )}

            {step === 4 && pendingReviews.length > 0 && (
              <div>
                <h2 className="font-bold mb-3">逐筆審核待查項目</h2>
                <div className="border rounded p-3 mb-3">
                  <p><strong>發票號碼：</strong>{pendingReviews[currentReviewIndex]["發票號碼"]}</p>
                  <p><strong>賣方統編：</strong>{pendingReviews[currentReviewIndex]["賣方統編"]}</p>
                  <p><strong>明細：</strong>{pendingReviews[currentReviewIndex].items.join(', ')}</p>
                </div>
                <input value={newKeyword} onChange={e => setNewKeyword(e.target.value)} placeholder="新增關鍵字" className="border p-2 w-full mb-2" />
                <label className="block mb-2">
                  <input type="checkbox" checked={includeSellerID} onChange={e => setIncludeSellerID(e.target.checked)} /> 包含賣方統編
                </label>
                <div className="flex gap-2">
                  <button onClick={() => handleReviewDecision('deductible')} className="flex-1 bg-green-500 text-white py-2 rounded">可扣抵</button>
                  <button onClick={() => handleReviewDecision('non-deductible')} className="flex-1 bg-red-500 text-white py-2 rounded">不可扣抵</button>
                </div>
              </div>
            )}

            {step === 5 && (
              <div className="text-center">
                <h2 className="text-lg font-bold mb-3">所有審核完成</h2>
                <div className="flex flex-col gap-3">
                  <button onClick={handleConfirmCompletion} className="bg-blue-500 text-white px-4 py-2 rounded">確認完成並送出 n8n</button>
                  <button onClick={downloadResults} className="bg-green-500 text-white px-4 py-2 rounded">下載 Excel 結果</button>
                </div>
              </div>
            )}

            {step === 6 && <p className="text-center text-green-600">已完成，新增的規則已送出 n8n ✅</p>}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<InvoiceReviewSystem />);
  </script>
</body>
</html>
